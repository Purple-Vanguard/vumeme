name: Codex PR Notebook - Apply Patch

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: codex-apply-${{ github.event.issue.number }}
  cancel-in-progress: false

jobs:
  apply:
    if: ${{ github.event.issue.pull_request }}
    runs-on: ubuntu-latest
    steps:
      - name: Gate: only collaborators can trigger /apply
        if: startsWith(github.event.comment.body, '/apply')
        run: |
          assoc="${{ github.event.comment.author_association }}"
          case "$assoc" in
            OWNER|MEMBER|COLLABORATOR) exit 0 ;;
            *) echo "Not allowed: $assoc" && exit 1 ;;
          esac

      - name: Fetch PR data
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.issue.number;
            const {owner, repo} = context.repo;
            const pr = await github.rest.pulls.get({owner, repo, pull_number: prNumber});
            core.setOutput("number", String(prNumber));
            core.setOutput("head_ref", pr.data.head.ref);
            core.setOutput("head_repo", pr.data.head.repo.full_name);
            core.setOutput("labels", JSON.stringify(pr.data.labels.map(l => l.name)));

      - name: Gate: same-repo PRs only (avoid fork write risk)
        run: |
          if [ "${{ steps.pr.outputs.head_repo }}" != "${{ github.repository }}" ]; then
            echo "Refusing to write to fork PR: ${{ steps.pr.outputs.head_repo }}"
            exit 1
          fi

      - name: Load labels
        id: labels
        uses: actions/github-script@v7
        with:
          script: |
            const labels = JSON.parse(`${{ steps.pr.outputs.labels }}`);
            core.setOutput("has_autopilot", labels.includes("codex:autopilot") ? "true" : "false");
            core.setOutput("allow_workflows", labels.includes("allow-github-workflows") ? "true" : "false");

      - name: Extract latest Codex diff (or specific one)
        id: extract
        uses: actions/github-script@v7
        env:
          CODEX_BOT_LOGINS: codex,chatgpt-codex-connector
          MODE_HAS_AUTOPILOT: ${{ steps.labels.outputs.has_autopilot }}
        with:
          script: |
            const {owner, repo} = context.repo;
            const prNumber = context.payload.issue.number;
            const body = context.payload.comment.body || "";
            const isManual = body.startsWith("/apply");
            const botLogins = (process.env.CODEX_BOT_LOGINS || "codex")
              .split(",")
              .map(s => s.trim())
              .filter(Boolean);
            const authorLogin = (context.payload.comment.user?.login || "");
            const isFromCodexBot = botLogins.includes(authorLogin);

            // Decide whether to run:
            // - manual: /apply
            // - autopilot: codex bot posted diff AND PR labeled codex:autopilot
            const shouldRun = isManual || (isFromCodex && process.env.MODE_HAS_AUTOPILOT === "true");
            const shouldRun = isManual || (isFromCodexBot && process.env.MODE_HAS_AUTOPILOT === "true");

            if (!shouldRun) {
              core.setOutput("skip", "true");
              return;
            }

            // Load all comments, find latest codex diff block
            const comments = await github.paginate(github.rest.issues.listComments, {
              owner, repo, issue_number: prNumber, per_page: 100
            });

            const diffRe = /```(?:diff|patch)\n([\s\S]*?)```/m;

            // const codexLogin = process.env.CODEX_BOT_LOGIN;
            let target = null;

            // If current comment already contains a diff/patch block, apply it (manual or bot)
            if (diffRe.test(body)) {
              target = context.payload.comment; // current comment
            } else {
              for (let i = comments.length - 1; i >= 0; i--) {
                const c = comments[i];
                if (!diffRe.test(c.body || "")) continue;
                // Manual /apply: accept latest diff from ANY author (already gated by collaborator check)
                if (isManual) {
                  target = c;
                  break;
                }
                // Autopilot: accept only from codex bot identities
                if (!botLogins.includes(c.user?.login || "")) continue;
                target = c;
                break;
              }
            }

            if (!target) {
              // Manual apply should fail loudly; autopilot should just skip quietly.
              if (isManual) {
                throw new Error("No ```diff```/```patch``` block found to apply. Ask Codex to output a unified diff.");
              }
              core.setOutput("skip", "true");
              return;            }

            const m = (target.body || "").match(diffRe);
            const patch = m ? m[1] : "";
            core.setOutput("skip", "false");
            core.setOutput("codex_comment_id", String(target.id));
            core.setOutput("codex_comment_url", target.html_url);
            require("fs").writeFileSync("codex.patch", patch, "utf8");

      - name: Stop early if not applicable
        if: steps.extract.outputs.skip == 'true'
        run: echo "Skip."

      - name: Checkout PR branch
        if: steps.extract.outputs.skip != 'true'
        uses: actions/checkout@v5
        with:
          ref: ${{ steps.pr.outputs.head_ref }}
          fetch-depth: 0

      - name: Apply patch safely + commit trace
        if: steps.extract.outputs.skip != 'true'
        env:
          CODEX_COMMENT_ID: ${{ steps.extract.outputs.codex_comment_id }}
          CODEX_COMMENT_URL: ${{ steps.extract.outputs.codex_comment_url }}
          ALLOW_WORKFLOWS: ${{ steps.labels.outputs.allow_workflows }}
        run: |
          python3 .github/scripts/apply_patch.py codex.patch

      - name: Run CI (project-defined)
        if: steps.extract.outputs.skip != 'true'
        run: |
          bash .github/scripts/ci.sh

      - name: Push changes
        if: steps.extract.outputs.skip != 'true'
        run: |
          git push origin HEAD:${{ steps.pr.outputs.head_ref }}

      - name: Comment result
        if: steps.extract.outputs.skip != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const {owner, repo} = context.repo;
            const prNumber = context.payload.issue.number;
            await github.rest.issues.createComment({
              owner, repo, issue_number: prNumber,
              body: `✅ Applied patch and pushed commits.\n\n- Patch source: ${{ steps.extract.outputs.codex_comment_url }}\n- Head: \`${{ steps.pr.outputs.head_ref }}\``
            });

      - name: On failure, post logs hinting Codex to iterate
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const {owner, repo} = context.repo;
            const prNumber = context.payload.issue.number;
            await github.rest.issues.createComment({
              owner, repo, issue_number: prNumber,
              body: `❌ Apply/CI failed.\n\n@codex please fix the failure. Focus on minimal diff.`
            });
